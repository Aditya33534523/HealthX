{% extends "base.html" %} {% block title %}Chat - PharmaCare{% endblock %} {%
block content %}
<div class="h-screen flex flex-col">
    <!-- Header -->
    <header
        class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 shadow-lg"
    >
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-full">
                    <svg
                        class="w-6 h-6 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                        ></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold">PharmaCare Assistant</h1>
                    <p class="text-sm text-blue-100">
                        Drug Safety & Alert System
                    </p>
                </div>
            </div>
            <a
                href="{{ url_for('logout') }}"
                class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition"
            >
                Logout
            </a>
        </div>
    </header>

    <!-- Quick Actions -->
    <div class="bg-white shadow-sm border-b border-gray-200 p-3">
        <div class="max-w-6xl mx-auto flex gap-2 overflow-x-auto">
            <button
                onclick="
                    sendQuickMessage(
                        'Show me safety alerts for common medications',
                    )
                "
                class="flex items-center gap-2 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-full text-sm font-medium whitespace-nowrap"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                    ></path>
                </svg>
                Safety Alerts
            </button>
            <button
                onclick="
                    sendQuickMessage(
                        'Check if any drugs are banned or recalled',
                    )
                "
                class="flex items-center gap-2 px-4 py-2 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-full text-sm font-medium whitespace-nowrap"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    ></path>
                </svg>
                Drug Status
            </button>
            <button
                onclick="sendQuickMessage('Tell me about drug interactions')"
                class="flex items-center gap-2 px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-full text-sm font-medium whitespace-nowrap"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                    ></path>
                </svg>
                Interactions
            </button>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messages-container" class="flex-1 overflow-y-auto p-4">
        <div id="messages" class="max-w-4xl mx-auto space-y-4">
            <!-- Welcome Message -->
            <div class="flex items-start gap-3">
                <div
                    class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full"
                >
                    <svg
                        class="w-4 h-4 text-white"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"
                        ></path>
                    </svg>
                </div>
                <div
                    class="flex-1 bg-white rounded-2xl rounded-tl-sm p-4 shadow"
                >
                    <p class="text-gray-800">
                        Hello! I'm your Pharmaceutical Assistant. I can help you
                        with:
                    </p>
                    <ul class="mt-2 space-y-1 text-gray-700">
                        <li>• Drug withdrawal alerts</li>
                        <li>• Safety alerts & warnings</li>
                        <li>• ADR (Adverse Drug Reaction) information</li>
                        <li>• Government alerts and drug bans</li>
                        <li>• Drug interactions</li>
                    </ul>
                    <p class="text-sm text-gray-500 mt-3">
                        How can I assist you today?
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-gray-200 p-4 shadow-lg">
        <div class="max-w-4xl mx-auto flex gap-2">
            <textarea
                id="message-input"
                placeholder="Ask about drug alerts, safety info, or interactions..."
                rows="1"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            ></textarea>
            <button
                id="send-button"
                onclick="sendMessage()"
                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-full hover:from-blue-700 hover:to-indigo-700 transition shadow-lg"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                    ></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const messagesContainer = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");

    let isTyping = false;

    // Auto-resize textarea
    messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
    });

    // Send on Enter (Shift+Enter for new line)
    messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function scrollToBottom() {
        const container = document.getElementById("messages-container");
        container.scrollTop = container.scrollHeight;
    }

    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex items-start gap-3 ${isUser ? "flex-row-reverse" : ""}`;

        const avatar = document.createElement("div");
        avatar.className = isUser
            ? "bg-gray-400 p-2 rounded-full"
            : "bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full";
        avatar.innerHTML = isUser
            ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
            : '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>';

        const bubble = document.createElement("div");
        bubble.className = isUser
            ? "bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl rounded-tr-sm p-4 shadow max-w-lg"
            : "bg-white rounded-2xl rounded-tl-sm p-4 shadow max-w-lg";
        bubble.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        scrollToBottom();
    }

    function showTyping() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.className = "flex items-start gap-3";
        typingDiv.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm p-4 shadow">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `;
        messagesContainer.appendChild(typingDiv);
        scrollToBottom();
    }

    function hideTyping() {
        const typing = document.getElementById("typing-indicator");
        if (typing) typing.remove();
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isTyping) return;

        // Add user message
        addMessage(message, true);
        messageInput.value = "";
        messageInput.style.height = "auto";

        // Show typing
        isTyping = true;
        sendButton.disabled = true;
        showTyping();

        try {
            const response = await fetch("/api/send-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message }),
            });

            const data = await response.json();

            hideTyping();

            if (data.success) {
                addMessage(data.response);
            } else {
                addMessage(data.response || "Sorry, I encountered an error.");
            }
        } catch (error) {
            hideTyping();
            addMessage(
                "Unable to connect to the backend. Please check if the service is running.",
            );
        } finally {
            isTyping = false;
            sendButton.disabled = false;
        }
    }

    function sendQuickMessage(message) {
        messageInput.value = message;
        sendMessage();
    }
</script>
{% endblock %}
