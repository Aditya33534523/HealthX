{% extends "base.html" %} 
{% block title %}Chat - PharmaCare{% endblock %} 
{% block content %}

<div class="h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-full">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold">PharmaCare Assistant</h1>
                    <p class="text-sm text-blue-100">Drug Safety & Alert System</p>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition">
                Logout
            </a>
        </div>
    </header>

    <!-- Quick Actions -->
    <div class="bg-white shadow-sm border-b border-gray-200 p-3">
        <div class="max-w-6xl mx-auto flex gap-2 overflow-x-auto">
            <button onclick="sendQuickMessage('Show me safety alerts for common medications')" 
                class="flex items-center gap-2 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-full text-sm font-medium whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                Safety Alerts
            </button>
            <button onclick="sendQuickMessage('Check if any drugs are banned or recalled')"
                class="flex items-center gap-2 px-4 py-2 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-full text-sm font-medium whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Drug Status
            </button>
            <button onclick="sendQuickMessage('Tell me about drug interactions')"
                class="flex items-center gap-2 px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-full text-sm font-medium whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Interactions
            </button>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messages-container" class="flex-1 overflow-y-auto p-4">
        <div id="messages" class="max-w-4xl mx-auto space-y-4">
            <!-- Welcome Message -->
            <div class="flex items-start gap-3">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                </div>
                <div class="flex-1 bg-white rounded-2xl rounded-tl-sm p-4 shadow">
                    <p class="text-gray-800">Hello! I'm your Pharmaceutical Assistant. I can help you with:</p>
                    <ul class="mt-2 space-y-1 text-gray-700">
                        <li>• Drug withdrawal alerts</li>
                        <li>• Safety alerts & warnings</li>
                        <li>• ADR (Adverse Drug Reaction) information</li>
                        <li>• Government alerts and drug bans</li>
                        <li>• Drug interactions</li>
                    </ul>
                    <p class="text-sm text-gray-500 mt-3">How can I assist you today?</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white border-t border-gray-200 p-4 shadow-lg">
        <div class="max-w-4xl mx-auto flex gap-2">
            <textarea
                id="message-input"
                placeholder="Ask about drug alerts, safety info, or interactions..."
                rows="1"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            ></textarea>
            <button id="send-button" onclick="sendMessage()"
                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-full hover:from-blue-700 hover:to-indigo-700 transition shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const messagesContainer = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const userPhone = "{{ phone }}";

    let isTyping = false;
    let lastDrugMentioned = null;

    messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
    });

    messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function scrollToBottom() {
        const container = document.getElementById("messages-container");
        container.scrollTop = container.scrollHeight;
    }

    function detectDrugName(text) {
        const commonDrugs = ['aspirin', 'metformin', 'ranitidine', 'ibuprofen', 'paracetamol'];
        const lowerText = text.toLowerCase();
        for (let drug of commonDrugs) {
            if (lowerText.includes(drug)) {
                return drug.charAt(0).toUpperCase() + drug.slice(1);
            }
        }
        return null;
    }

    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex items-start gap-3 ${isUser ? "flex-row-reverse" : ""}`;

        const avatar = document.createElement("div");
        avatar.className = isUser
            ? "bg-gray-400 p-2 rounded-full"
            : "bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full";
        avatar.innerHTML = isUser
            ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
            : '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>';

        const bubble = document.createElement("div");
        bubble.className = isUser
            ? "bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl rounded-tr-sm p-4 shadow max-w-lg"
            : "bg-white rounded-2xl rounded-tl-sm p-4 shadow max-w-lg";
        bubble.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>`;

        // Add WhatsApp button for bot responses if phone number exists
        if (!isUser && userPhone && lastDrugMentioned) {
            const whatsappBtn = document.createElement("button");
            whatsappBtn.className = "mt-3 flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition";
            whatsappBtn.innerHTML = `
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                Send to WhatsApp
            `;
            whatsappBtn.onclick = () => sendToWhatsApp(lastDrugMentioned);
            bubble.appendChild(whatsappBtn);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        scrollToBottom();
    }

    function showTyping() {
        const typingDiv = document.createElement("div");
        typingDiv.id = "typing-indicator";
        typingDiv.className = "flex items-start gap-3";
        typingDiv.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-2 rounded-full">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm p-4 shadow">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>`;
        messagesContainer.appendChild(typingDiv);
        scrollToBottom();
    }

    function hideTyping() {
        const typing = document.getElementById("typing-indicator");
        if (typing) typing.remove();
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isTyping) return;

        // Detect drug name
        lastDrugMentioned = detectDrugName(message);

        addMessage(message, true);
        messageInput.value = "";
        messageInput.style.height = "auto";

        isTyping = true;
        sendButton.disabled = true;
        showTyping();

        try {
            const response = await fetch("/api/send-message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message }),
            });

            const data = await response.json();
            hideTyping();

            if (data.success) {
                addMessage(data.response);
            } else {
                addMessage(data.response || "Sorry, I encountered an error.");
            }
        } catch (error) {
            hideTyping();
            addMessage("Unable to connect to the backend. Please check if the service is running.");
        } finally {
            isTyping = false;
            sendButton.disabled = false;
        }
    }

    async function sendToWhatsApp(drugName) {
        if (!userPhone) {
            alert("Please add your phone number in settings to receive WhatsApp messages.");
            return;
        }

        try {
            const response = await fetch("/api/whatsapp/send-drug-info", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ drug_name: drugName }),
            });

            const data = await response.json();
            
            if (data.success) {
                alert("✅ Drug information sent to your WhatsApp!");
            } else {
                alert("❌ Failed to send WhatsApp message: " + data.error);
            }
        } catch (error) {
            alert("❌ Error sending WhatsApp message");
        }
    }

    function sendQuickMessage(message) {
        messageInput.value = message;
        sendMessage();
    }
</script>

{% endblock %}